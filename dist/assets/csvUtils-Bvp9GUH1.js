function N(e){const t=e.slice(0,256),i=t.startsWith("PK"),d=(t.match(/[^\x09\x0A\x0D\x20-\x7E]/g)||[]).length/Math.max(1,t.length);if(i||d>.1)throw new Error("El archivo parece ser un archivo binario (por ejemplo .xlsx). Exporte el archivo a CSV (UTF-8) antes de subir.");const n=e.split(/\r?\n/).filter(o=>o.trim()!=="");if(n.length===0)return[];let r=0;for(let o=0;o<n.length;o++)if(/DATA HEADER \(EN\)/i.test(n[o])){r=o+1;break}const l=q(n[r]),h={sede:"headquarters",sede_id:"headquarters","sede id":"headquarters",indicador:"indicator",indicador_id:"indicator",numerador:"numerator",denominador:"denominator",annio:"year",anio:"year",año:"year",mes:"month",trimestre:"quarter",semestre:"semester",usuario:"user",headquarters:"headquarters",indicator:"indicator",numerator:"numerator",denominator:"denominator",year:"year",month:"month",quarter:"quarter",semester:"semester",user:"user"};function f(o){return o.replace(/\(.*\)/,"").trim()}function b(o){return o.replace(/[ÁÀÂÄáàâä]/g,"a").replace(/[ÉÈÊËéèêë]/g,"e").replace(/[ÍÌÎÏíìîï]/g,"i").replace(/[ÓÒÔÖóòôö]/g,"o").replace(/[ÚÙÛÜúùûü]/g,"u").replace(/[Ññ]/g,"n")}function g(o){if(!o)return"";let s=String(o).trim().toLowerCase();s=f(s),s=b(s);const m=s.match(/^([a-z0-9]+)/);return m?m[1]:s.replace(/[^a-z0-9]+/g,"_")}const p=l.map(o=>{const s=g(o);return h[s]??(o||"").toString().trim()}),a=[];for(let o=1;o<n.length;o++){if(o<=r)continue;const s=q(n[o]);if(s.length===0)continue;const m={};for(let c=0;c<p.length;c++)m[p[c]]=s[c]??"";a.push(m)}return a}function q(e){const t=[];let i="",d=!1;for(let n=0;n<e.length;n++){const r=e[n];r==='"'?d&&e[n+1]==='"'?(i+='"',n++):d=!d:r===","&&!d?(t.push(i.trim()),i=""):i+=r}return t.push(i.trim()),t}function y(e){const t=[];return["headquarters","indicator","numerator","denominator","year","user"].forEach(n=>{(!e[n]||e[n].trim()==="")&&t.push(`${n} is required / ${n==="headquarters"?"sede es requerida":n==="indicator"?"indicador es requerido":n+" is required"}`)}),["headquarters","indicator","numerator","denominator","year","month","quarter","semester","user"].forEach(n=>{e[n]&&e[n].trim()!==""&&isNaN(Number(e[n]))&&t.push(`${n} must be a number`)}),e.numerator&&e.denominator&&Number(e.denominator)===0&&t.push("denominator must not be zero"),{valid:t.length===0,errors:t}}function A(e){return{headquarters:Number(e.headquarters),indicator:Number(e.indicator),numerator:Number(e.numerator),denominator:Number(e.denominator),year:Number(e.year),month:e.month?Number(e.month):null,quarter:e.quarter?Number(e.quarter):null,semester:e.semester?Number(e.semester):null,user:Number(e.user)}}function u(e){if(e==null)return"";const t=String(e);return t.includes(",")||t.includes('"')||t.includes(`
`)?'"'+t.replace(/"/g,'""')+'"':t}function D(e=[],t=[]){const i={sede:"sede (ID de la sede)",indicador:"indicador (ID del indicador)",numerador:"numerador",denominador:"denominador",annio:"año",mes:"mes",trimestre:"trimestre",semestre:"semestre",usuario:"usuario (ID)"},d=["headquarters","indicator","numerator","denominator","year","month","quarter","semester","user"],n={sede:"ID numerico de la sede (ver tabla de mapeo mas abajo). Ej: 1 = Aurora",indicador:"ID numerico del indicador (ver tabla de mapeo). Ej: 2 = COD-001 - Tasa de ocupacion",numerador:"Valor numerador usado para calcular el resultado (numero)",denominador:"Valor denominador usado para calcular el resultado (numero, distinto de cero)",annio:"Año del resultado (ej. 2025)",mes:"Mes del resultado (1-12) - opcional",trimestre:"Trimestre (1-4) - opcional",semestre:"Semestre (1-2) - opcional",usuario:"ID del usuario que registra el resultado (numero)"},r=[];r.push("INSTRUCCIONES: Este archivo es una plantilla para la carga masiva de resultados."),r.push('INSTRUCCIONES: La primera sección muestra nombres amigables en español y una breve descripcion. La fila marcada como "DATA HEADER (EN)" es la fila de encabezado que el sistema utiliza para importar los datos. No la borre ni la modifique.'),r.push(""),r.push("COLUMNS (ES),DESCRIPTION");for(const a of Object.keys(i))r.push(`${u(i[a])},${u(n[a]??"")}`);r.push(""),r.push("MAPA DE ENCABEZADOS:ESPANOL -> INGLES"),r.push("encabezado_es,encabezado_en");const l=Object.keys(i),h=d;for(let a=0;a<l.length;a++)r.push(`${u(i[l[a]])},${u(h[a])}`);r.push(""),r.push("DATA HEADER (EN)"),r.push(d.map(u).join(","));const f=t&&t.length>0?t[0].id??t[0].value??"":"1",b=e&&e.length>0?e[0].id??e[0].value??"":"2",g=[f,b,10,100,new Date().getFullYear(),1,1,1,1];r.push(g.map(u).join(",")),r.push(""),r.push("Mapa de sedes / Headquarters Mapping"),r.push("id,nombre");for(const a of t||[]){const o=a.id??a.value??a.headquarter_id??"",s=a.name??a.nombre??a.headquarter_name??"";r.push([u(o),u(s)].join(","))}r.push(""),r.push("mapa de indicadores / INDICATORS_MAPPING"),r.push("id,codigo,nombre,meta,unidad_medida");for(const a of e||[]){const o=a.id??a.value??"",s=a.code??a.codigo??"",m=a.name??a.nombre??"",c=a.target??a.meta??"",E=a.measurementUnit??a.unidad_medida??"";r.push([u(o),u(s),u(m),u(c),u(E)].join(","))}const p=r.join(`
`);return new Blob([p],{type:"text/csv;charset=utf-8;"})}export{D as generateTemplateCSV,A as mapRowToCreatePayload,N as parseCSV,y as validateRowForCreate};
